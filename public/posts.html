<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - VibeApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .post-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .post-list th,
        .post-list td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .post-list th {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
        }

        .post-list tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .pagination {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: center;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="glass-container">
        <header>
            <h1 class="logo" style="cursor: pointer" onclick="location.href='/'">Vibe<span>App</span></h1>
            <nav>
                <ul></ul>
            </nav>
        </header>

        <main>
            <section style="display: flex; justify-content: space-between; align-items: center">
                <h2 class="hero-title" style="font-size: 2rem; margin: 0">Recent <span>Posts</span></h2>
                <button class="btn btn-primary btn-small" onclick="location.href='/post_form.html'">+ New Post</button>
            </section>

            <table class="post-list">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="posts-tbody">
                    <!-- Posts will be loaded here -->
                </tbody>
            </table>

            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/app.js"></script>
    <script>
        let currentPage = 1;

        async function loadPosts(page = 1) {
            currentPage = page;
            const response = await API.call(`/api/posts?page=${page}`);
            if (response.ok) {
                const data = await response.json();
                renderPosts(data.posts);
                renderPagination(data.currentPage, data.totalPages);
            } else {
                console.error('Failed to load posts');
            }
        }

        function renderPosts(posts) {
            const tbody = document.getElementById('posts-tbody');
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td>${post.no}</td>
                    <td><a href="#" onclick="editPost(${post.no})" style="color: white; text-decoration: none">${post.title}</a></td>
                    <td>${post.authorName}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td class="action-btns">
                        <button type="button" class="btn btn-secondary btn-small" onclick="editPost(${post.no})">Edit</button>
                        <button type="button" class="btn btn-primary btn-small" style="background: #ff3b3b" onclick="deletePost(${post.no})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(current, total) {
            const container = document.getElementById('pagination');
            let html = '';
            for (let i = 1; i <= total; i++) {
                html += `<button class="btn btn-secondary btn-small ${i === current ? 'active' : ''}" onclick="loadPosts(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        async function deletePost(no) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            const response = await API.call(`/api/posts/${no}`, { method: 'DELETE' });
            if (response.ok) {
                alert('Post deleted');
                loadPosts(currentPage);
            } else {
                const status = response.status;
                let msg = 'Failed to delete post';
                try {
                    const data = await response.json();
                    msg += `: ${data.message || status}`;
                } catch (e) {
                    msg += `: ${status}`;
                }
                alert(msg);
            }
        }

        function editPost(no) {
            location.href = `/post_form.html?no=${no}`;
        }

        document.addEventListener('DOMContentLoaded', () => loadPosts(1));
    </script>
</body>

</html>